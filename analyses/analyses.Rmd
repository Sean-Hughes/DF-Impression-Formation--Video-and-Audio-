---
title: "Analyses"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE)
```

# Dependencies & functions

```{r}

# dependencies -----
library(tidyverse)
#library(ggthemes)
library(knitr)
library(kableExtra)
#library(broom)
library(effsize)
library(BayesFactor)
library(metafor)
library(ez)
library(schoRsch)
library(TOSTER)
library(psych)
library(rsample)
library(broom)
library(purrr)
library(brms)
library(sjPlot)
library(tidybayes)
library(bayestestR)

options(knitr.kable.NA = "-")

set.seed(42)

# create necessary folder
dir.create("models")

```

# Data and exclusions

```{r}

# full data
data_processed <- read_csv("../data/processed/4_data_participant_level_with_hand_scoring.csv") %>%
  # set factor levels for t test comparisons
  mutate(source_valence = fct_relevel(source_valence,
                                      "negative",
                                      "positive"),
         experiment_condition = fct_relevel(experiment_condition,
                                            "genuine",
                                            "deepfaked"))

# apply exclusions
data_after_exclusions <- data_processed %>%
  filter(exclude_subject == FALSE)
  
```

# Demographics

```{r}

data_processed %>%
  group_by(experiment) %>%
  summarise(n = n(),
            excluded_n = sum(exclude_subject > 0),
            excluded_percent = (excluded_n / n) *100) %>%
  mutate_if(is.numeric, round, digits = 1) %>%
  kable(align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data_after_exclusions %>%
  group_by(experiment) %>%
  summarise(n = n(),
            age_mean = mean(age, na.rm = TRUE),
            age_sd = sd(age, na.rm = TRUE)) %>%
  mutate_if(is.numeric, round, digits = 1) %>%
  kable(align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data_after_exclusions %>%
  count(experiment, gender) %>%
  spread(gender, n) %>%
  kable(knitr.kable.NA = "/", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

# Changing evaluations

## Self-reported evaluations

```{r}

fit_selfreport <- 
  brm(formula = mean_self_reported_evaluation ~ source_valence * experiment_condition + (1 | experiment),
      data    = data_after_exclusions, 
      file    = "models/fit_selfreport",
      prior   = prior(normal(0, 10)),
      iter    = 6000,
      warmup  = 3000,
      control = list(adapt_delta = 0.95),
      chains  = 4,
      cores   = parallel::detectCores())

# # inspect convergence
# fit_selfreport

#plot_model(fit_selfreport)
plot_model(fit_selfreport, type = "pred", terms = c("source_valence", "experiment_condition"))

# percent moderation
draws_sr <- 
  bind_cols(
    select(spread_draws(fit_selfreport, b_source_valencepositive), b_source_valencepositive),
    select(spread_draws(fit_selfreport, b_experiment_conditiondeepfaked), b_experiment_conditiondeepfaked),
    select(spread_draws(fit_selfreport, `b_source_valencepositive:experiment_conditiondeepfaked`), `b_source_valencepositive:experiment_conditiondeepfaked`)
  ) %>%
  rename(main_valence = b_source_valencepositive,
         main_experiment_condition = b_experiment_conditiondeepfaked,
         interaction = `b_source_valencepositive:experiment_conditiondeepfaked`) %>%
  mutate(effect_genuine = main_valence,
         effect_deepfaked = main_valence + main_experiment_condition + interaction,
         #percent_moderation = (main_experiment_condition + interaction)/main_valence *100,  # alt method, same result
         percent_comparison = (effect_deepfaked/effect_genuine)*100)

# results
estimates_sr <- 
  map_estimate(draws_sr) %>%
  mutate(pomp_MAP_Estimate = ifelse(Parameter == "percent_comparison", NA, (((MAP_Estimate+3)/6) - .50)*100)) %>%
  full_join(bayestestR::hdi(draws_sr, ci = .95) %>%
              rename(CI_95_lower = CI_low,
                     CI_95_upper = CI_high) %>%
              mutate(pomp_CI_95_lower = ifelse(Parameter == "percent_comparison", NA, (((CI_95_lower+3)/6) - .50)*100),
                     pomp_CI_95_upper = ifelse(Parameter == "percent_comparison", NA, (((CI_95_upper+3)/6) - .50)*100)) %>%
              as_tibble(),
            by = "Parameter") %>%
  full_join(bayestestR::hdi(draws_sr, ci = .90) %>%
              as_tibble() %>%
              rename(CI_90_lower = CI_low,
                     CI_90_upper = CI_high),
            by = "Parameter") %>%
  full_join(draws_sr %>%
              select(-percent_comparison) %>%
              gather(Parameter, value) %>%
              group_by(Parameter) %>%
              summarize(pd = mean(value > 0)) %>%
              mutate(p = pd_to_p(pd, direction = "one-sided")) %>%
              ungroup() %>%
              select(Parameter, p),
            by = "Parameter") %>%
  select(Parameter, MAP_Estimate, CI_95_lower, CI_95_upper, 
         CI_90_lower, CI_90_upper, pomp_MAP_Estimate, pomp_CI_95_lower, pomp_CI_95_upper, p)

comparison_string_sr <- 
  paste0("Deepfakes are ",
         estimates_sr %>% 
           filter(Parameter == "percent_comparison") %>% 
           pull(MAP_Estimate) %>% 
           round(1),
         "% (95% CI [",
         estimates_sr %>% 
           filter(Parameter == "percent_comparison") %>% 
           pull(CI_95_lower) %>% 
           round(1),
         ", ",
         estimates_sr %>%
           filter(Parameter == "percent_comparison") %>% 
           pull(CI_95_upper) %>% 
           round(1),
         "]) as effective as genine content in changing self-reported evaluations")

noninferiority_sr <- 
  ifelse(estimates_sr %>% filter(Parameter == "effect_genuine") %>% pull(CI_95_lower) <
           estimates_sr %>% filter(Parameter == "effect_deepfaked") %>% pull(CI_90_lower),
         "Deepfakes were found to be non-inferior to genuine content",
         "Deepfakes were not found to be non-inferior to genuine content")

estimates_sr %>%
  mutate_at(.vars = c("MAP_Estimate", "CI_95_lower", "CI_95_upper", "CI_90_lower", "CI_90_upper"), round, digits = 2) %>%
  mutate_at(.vars = c("pomp_MAP_Estimate", "pomp_CI_95_lower", "pomp_CI_95_upper"), round, digits = 1) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

`r noninferiority_sr`

`r comparison_string_sr`

## Implicit

```{r}

fit_implicit <- 
  brm(formula = IAT_D2 ~ source_valence * experiment_condition + (1 | experiment),
      data    = data_after_exclusions, 
      file    = "models/fit_implicit",
      prior   = prior(normal(0, 10)),
      iter    = 6000,
      warmup  = 3000,
      control = list(adapt_delta = 0.95),
      chains  = 4,
      cores   = parallel::detectCores())

# # inspect convergence
# fit_implicit

#plot_model(fit_implicit)
plot_model(fit_implicit, type = "pred", terms = c("source_valence", "experiment_condition"))

# percent moderation
draws_imp <- 
  bind_cols(
    select(spread_draws(fit_implicit, b_source_valencepositive), b_source_valencepositive),
    select(spread_draws(fit_implicit, b_experiment_conditiondeepfaked), b_experiment_conditiondeepfaked),
    select(spread_draws(fit_implicit, `b_source_valencepositive:experiment_conditiondeepfaked`), `b_source_valencepositive:experiment_conditiondeepfaked`)
  ) %>%
  rename(main_valence = b_source_valencepositive,
         main_experiment_condition = b_experiment_conditiondeepfaked,
         interaction = `b_source_valencepositive:experiment_conditiondeepfaked`) %>%
  mutate(effect_genuine = main_valence,
         effect_deepfaked = main_valence + main_experiment_condition + interaction,
         #percent_moderation = (main_experiment_condition + interaction)/main_valence *100,  # alt method, same result
         percent_comparison = (effect_deepfaked/effect_genuine)*100)

# results
estimates_imp <- 
  map_estimate(draws_imp) %>%
  mutate(pomp_MAP_Estimate = ifelse(Parameter == "percent_comparison", NA, (((MAP_Estimate+2)/4) - .50)*100)) %>%
  full_join(bayestestR::hdi(draws_imp, ci = .95) %>%
              rename(CI_95_lower = CI_low,
                     CI_95_upper = CI_high) %>%
              mutate(pomp_CI_95_lower = ifelse(Parameter == "percent_comparison", NA, (((CI_95_lower+2)/4) - .50)*100),
                     pomp_CI_95_upper = ifelse(Parameter == "percent_comparison", NA, (((CI_95_upper+2)/4) - .50)*100)) %>%
              as_tibble(),
            by = "Parameter") %>%
  full_join(bayestestR::hdi(draws_imp, ci = .90) %>%
              as_tibble() %>%
              rename(CI_90_lower = CI_low,
                     CI_90_upper = CI_high),
            by = "Parameter") %>%
  full_join(draws_imp %>%
              select(-percent_comparison) %>%
              gather(Parameter, value) %>%
              group_by(Parameter) %>%
              summarize(pd = mean(value > 0)) %>%
              mutate(p = pd_to_p(pd, direction = "one-sided")) %>%
              ungroup() %>%
              select(Parameter, p),
            by = "Parameter") %>%
  select(Parameter, MAP_Estimate, CI_95_lower, CI_95_upper, 
         CI_90_lower, CI_90_upper, pomp_MAP_Estimate, pomp_CI_95_lower, pomp_CI_95_upper, p) 

comparison_string_imp <- 
  paste0("Deepfakes are ",
         estimates_imp %>% 
           filter(Parameter == "percent_comparison") %>% 
           pull(MAP_Estimate) %>% 
           round(1),
         "% (95% CI [",
         estimates_imp %>% 
           filter(Parameter == "percent_comparison") %>% 
           pull(CI_95_lower) %>% 
           round(1),
         ", ",
         estimates_imp %>% 
           filter(Parameter == "percent_comparison") %>% 
           pull(CI_95_upper) %>% 
           round(1),
         "]) as effective as genine content in changing implicit attitudes")

noninferiority_imp <- 
  ifelse(estimates_imp %>% filter(Parameter == "effect_genuine") %>% pull(CI_95_lower) <
           estimates_imp %>% filter(Parameter == "effect_deepfaked") %>% pull(CI_90_lower),
         "Deepfakes were found to be non-inferior to genuine content",
         "Deepfakes were not found to be non-inferior to genuine content")

estimates_imp %>%
  mutate_at(.vars = c("MAP_Estimate", "CI_95_lower", "CI_95_upper", "CI_90_lower", "CI_90_upper"), round, digits = 2) %>%
  mutate_at(.vars = c("pomp_MAP_Estimate", "pomp_CI_95_lower", "pomp_CI_95_upper"), round, digits = 1) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

`r noninferiority_imp`

`r comparison_string_imp`

## Behavioural intentions

```{r}

fit_intentions <- 
  brm(formula = IAT_D2 ~ source_valence * experiment_condition, # no random effect for experiment as only exp 6 assessed intentions
      data    = data_after_exclusions, 
      file    = "models/fit_intentions",
      prior   = prior(normal(0, 10)),
      iter    = 6000,
      warmup  = 3000,
      control = list(adapt_delta = 0.95),
      chains  = 4,
      cores   = parallel::detectCores())

# # inspect convergence
# fit_intentions

#plot_model(fit_intentions)
plot_model(fit_intentions, type = "pred", terms = c("source_valence", "experiment_condition"))

# percent moderation
draws_intentions <- 
  bind_cols(
    select(spread_draws(fit_intentions, b_source_valencepositive), b_source_valencepositive),
    select(spread_draws(fit_intentions, b_experiment_conditiondeepfaked), b_experiment_conditiondeepfaked),
    select(spread_draws(fit_intentions, `b_source_valencepositive:experiment_conditiondeepfaked`), `b_source_valencepositive:experiment_conditiondeepfaked`)
  ) %>%
  rename(main_valence = b_source_valencepositive,
         main_experiment_condition = b_experiment_conditiondeepfaked,
         interaction = `b_source_valencepositive:experiment_conditiondeepfaked`) %>%
  mutate(effect_genuine = main_valence,
         effect_deepfaked = main_valence + main_experiment_condition + interaction,
         #percent_moderation = (main_experiment_condition + interaction)/main_valence *100,  # alt method, same result
         percent_comparison = (effect_deepfaked/effect_genuine)*100)

# results
estimates_intentions <- 
  map_estimate(draws_intentions) %>%
  mutate(pomp_MAP_Estimate = ifelse(Parameter == "percent_comparison", NA, (((MAP_Estimate+2)/4) - .50)*100)) %>%
  full_join(bayestestR::hdi(draws_intentions, ci = .95) %>%
              rename(CI_95_lower = CI_low,
                     CI_95_upper = CI_high) %>%
              mutate(pomp_CI_95_lower = ifelse(Parameter == "percent_comparison", NA, (((CI_95_lower+2)/4) - .50)*100),
                     pomp_CI_95_upper = ifelse(Parameter == "percent_comparison", NA, (((CI_95_upper+2)/4) - .50)*100)) %>%
              as_tibble(),
            by = "Parameter") %>%
  full_join(bayestestR::hdi(draws_intentions, ci = .90) %>%
              as_tibble() %>%
              rename(CI_90_lower = CI_low,
                     CI_90_upper = CI_high),
            by = "Parameter") %>%
  full_join(draws_intentions %>%
              select(-percent_comparison) %>%
              gather(Parameter, value) %>%
              group_by(Parameter) %>%
              summarize(pd = mean(value > 0)) %>%
              mutate(p = pd_to_p(pd, direction = "one-sided")) %>%
              ungroup() %>%
              select(Parameter, p),
            by = "Parameter") %>%
  select(Parameter, MAP_Estimate, CI_95_lower, CI_95_upper, 
         CI_90_lower, CI_90_upper, pomp_MAP_Estimate, pomp_CI_95_lower, pomp_CI_95_upper, p) 

comparison_string_intentions <- 
  paste0("Deepfakes are ",
         estimates_intentions %>% 
           filter(Parameter == "percent_comparison") %>% 
           pull(MAP_Estimate) %>% 
           round(1),
         "% (95% CI [",
         estimates_intentions %>% 
           filter(Parameter == "percent_comparison") %>% 
           pull(CI_95_lower) %>% 
           round(1),
         ", ",
         estimates_intentions %>% 
           filter(Parameter == "percent_comparison") %>% 
           pull(CI_95_upper) %>% 
           round(1),
         "]) as effective as genine content in changing behavioural intentions")

noninferiority_intentions <- 
  ifelse(estimates_intentions %>% filter(Parameter == "effect_genuine") %>% pull(CI_95_lower) <
           estimates_intentions %>% filter(Parameter == "effect_deepfaked") %>% pull(CI_90_lower),
         "Deepfakes were found to be non-inferior to genuine content",
         "Deepfakes were not found to be non-inferior to genuine content")

estimates_intentions %>%
  mutate_at(.vars = c("MAP_Estimate", "CI_95_lower", "CI_95_upper", "CI_90_lower", "CI_90_upper"), round, digits = 2) %>%
  mutate_at(.vars = c("pomp_MAP_Estimate", "pomp_CI_95_lower", "pomp_CI_95_upper"), round, digits = 1) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

`r noninferiority_intentions`

`r comparison_string_intentions`

# Detection

## Inter-rater relibility

deepfake_detected:

```{r}

data_after_exclusions %>%
  select(deepfake_detected_rater_1,                                   
         deepfake_detected_rater_2) %>%
  cohen.kappa(.)

data_after_exclusions %>%
  summarize(perc_agreement = mean(deepfake_detected_rater_1 == deepfake_detected_rater_2, na.rm = TRUE))
  
```

manipulation_detected:

```{r}

data_after_exclusions %>%
  select(manipulation_detected_rater_1,                               
         manipulation_detected_rater_2) %>%
  cohen.kappa(.)

data_after_exclusions %>%
  summarize(perc_agreement = mean(manipulation_detected_rater_1 == manipulation_detected_rater_2, na.rm = TRUE))
  
```

deepfake_concept_check:

```{r}

data_after_exclusions %>%
  select(deepfake_concept_check_rater_1,                              
         deepfake_concept_check_rater_2) %>%
  cohen.kappa(.)

data_after_exclusions %>%
  summarize(perc_agreement = mean(deepfake_concept_check_rater_1 == deepfake_concept_check_rater_2, na.rm = TRUE))
  
```

## Can people accurately detect deepfakes?

Youden's J = sensitivity + specificity - 1

aka informedness aka "the probability of an informed decision (as opposed to a random guess) and takes into account all predictions" 

```{r}

if(file.exists("models/fit_classification_bootstraps.rds")){
  
  fit_classification_bootstraps <- read_rds("fit_classification_bootstraps.rds")
  
} else {
  
  # create bootstraps using out of bag method. makes a df with values that are collapsed dfs.
  boots <- data_after_exclusions %>%
    select(experiment_condition, deepfake_detected) %>%
    drop_na() %>%
    bootstraps(times = 2000)
  
  # generalize to a summarize function ------
  bootstrap_categorization_stats <- function(split) {
    
    data_counts <- analysis(split) %>%
      count(experiment_condition, deepfake_detected)
    
    TP <- pull(filter(data_counts, experiment_condition == "deepfaked" & deepfake_detected == TRUE),  n)
    FP <- pull(filter(data_counts, experiment_condition == "genuine"   & deepfake_detected == TRUE),  n)
    FN <- pull(filter(data_counts, experiment_condition == "deepfaked" & deepfake_detected == FALSE), n)
    TN <- pull(filter(data_counts, experiment_condition == "genuine"   & deepfake_detected == FALSE), n)
    
    #accuracy <- (TP+TN)/(TP+TN+FP+FN)
    sensitivity <- TP / (TP+FN)
    false_negative_rate <- 1 - sensitivity
    specificity <- TN / (TN+FP)
    false_positive_rate <- 1 - specificity
    
    # Youden's J statistic aka informedness aka "the probability of an informed decision (as opposed to a random guess) and takes into account all predictions". a zero value when a diagnostic test gives the same proportion of positive results for groups with and without the disease, i.e the test is useless. 
    informedness <- sensitivity + specificity - 1 
    
    balanced_accuracy <- (sensitivity + specificity)/2
    
    results <- 
      tibble(variable = c(
        #"accuracy",
        "balanced_accuracy",
        #"sensitivity",
        "false_negative_rate",
        #"specificity",
        "false_positive_rate",
        "informedness"
      ),
      value = c(
        #accuracy,
        balanced_accuracy,
        #sensitivity,
        false_negative_rate,
        #specificity,
        false_positive_rate,
        informedness
      ))
    
    return(results)
  }
  
  # apply to each bootstrap
  fit_classification_bootstraps <- boots %>% 
    mutate(categorization_stats = map(splits, bootstrap_categorization_stats)) %>%
    select(-splits) %>% 
    unnest(categorization_stats)
  
  write_rds(fit_classification_bootstraps, "models/fit_classification_bootstraps.rds")
  
}

fit_classification_bootstraps %>% 
  group_by(variable) %>%
  summarize(median = quantile(value, 0.500),
            ci_lower = quantile(value, 0.025),
            ci_upper = quantile(value, 0.975),
            .groups = "drop") %>%
  mutate_if(is.numeric, round, digits = 2) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

# Does detecting it matter?

Subset who received deepfaked videos but also detected them

```{r}

data_detectors_subset <- data_after_exclusions %>%
  filter(experiment_condition == "deepfaked" & deepfake_detected == TRUE)

```

## Self-reported evaluations

```{r}

fit_selfreport_deepfaked_detected <- 
  brm(formula = mean_self_reported_evaluation ~ source_valence + (1 | experiment),
      data    = data_detectors_subset, 
      file    = "models/fit_selfreport_deepfaked_detected",
      prior   = prior(normal(0, 10)),
      iter    = 6000,
      warmup  = 3000,
      control = list(adapt_delta = 0.95),
      chains  = 4,
      cores   = parallel::detectCores())

# # inspect convergence
# fit_selfreport_deepfaked_detected

#plot_model(fit_selfreport_deepfaked_detected)
plot_model(fit_selfreport_deepfaked_detected, type = "pred", terms = "source_valence")

draws_sr_deepfaked_detected <- 
  select(spread_draws(fit_selfreport_deepfaked_detected, b_source_valencepositive), b_source_valencepositive) %>%
  rename(effect_deepfake_detected = b_source_valencepositive) 

estimates_sr_deepfaked_detected <- 
  map_estimate(draws_sr_deepfaked_detected) %>%
  mutate(pomp_MAP_Estimate = ifelse(Parameter == "percent_comparison", NA, (((MAP_Estimate+3)/6) - .50)*100)) %>%
  full_join(bayestestR::hdi(draws_sr_deepfaked_detected, ci = .95) %>%
              rename(CI_95_lower = CI_low,
                     CI_95_upper = CI_high) %>%
              mutate(pomp_CI_95_lower = ifelse(Parameter == "percent_comparison", NA, (((CI_95_lower+3)/6) - .50)*100),
                     pomp_CI_95_upper = ifelse(Parameter == "percent_comparison", NA, (((CI_95_upper+3)/6) - .50)*100)) %>%
              as_tibble(),
            by = "Parameter") %>%
  full_join(draws_sr_deepfaked_detected %>%
              gather(Parameter, value) %>%
              group_by(Parameter) %>%
              summarize(pd = mean(value > 0)) %>%
              mutate(p = pd_to_p(pd, direction = "one-sided")) %>%
              ungroup() %>%
              select(Parameter, p),
            by = "Parameter") %>%
  select(Parameter, MAP_Estimate, CI_95_lower, CI_95_upper, pomp_MAP_Estimate, pomp_CI_95_lower, pomp_CI_95_upper, p) %>%
  mutate_at(.vars = c("MAP_Estimate", "CI_95_lower", "CI_95_upper"), round, digits = 2) %>%
  mutate_at(.vars = c("pomp_MAP_Estimate", "pomp_CI_95_lower", "pomp_CI_95_upper"), round, digits = 1)

estimates_sr_deepfaked_detected %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

## Implicit

```{r}

fit_implicit_deepfaked_detected <- 
  brm(formula = IAT_D2 ~ source_valence + (1 | experiment),
      data    = data_detectors_subset, 
      file    = "models/fit_implicit_deepfaked_detected",
      prior   = prior(normal(0, 10)),
      iter    = 6000,
      warmup  = 3000,
      control = list(adapt_delta = 0.95),
      chains  = 4,
      cores   = parallel::detectCores())

# # inspect convergence
# fit_implicit_deepfaked_detected

#plot_model(fit_implicit_deepfaked_detected)
plot_model(fit_implicit_deepfaked_detected, type = "pred", terms = "source_valence")

draws_imp_deepfaked_detected <- 
  select(spread_draws(fit_implicit_deepfaked_detected, b_source_valencepositive), b_source_valencepositive) %>%
  rename(effect_deepfake_detected = b_source_valencepositive) 

estimates_imp_deepfaked_detected <- 
  map_estimate(draws_imp_deepfaked_detected) %>%
  mutate(pomp_MAP_Estimate = ifelse(Parameter == "percent_comparison", NA, (((MAP_Estimate+3)/6) - .50)*100)) %>%
  full_join(bayestestR::hdi(draws_imp_deepfaked_detected, ci = .95) %>%
              rename(CI_95_lower = CI_low,
                     CI_95_upper = CI_high) %>%
              mutate(pomp_CI_95_lower = ifelse(Parameter == "percent_comparison", NA, (((CI_95_lower+3)/6) - .50)*100),
                     pomp_CI_95_upper = ifelse(Parameter == "percent_comparison", NA, (((CI_95_upper+3)/6) - .50)*100)) %>%
              as_tibble(),
            by = "Parameter") %>%
  full_join(draws_imp_deepfaked_detected %>%
              gather(Parameter, value) %>%
              group_by(Parameter) %>%
              summarize(pd = mean(value > 0)) %>%
              mutate(p = pd_to_p(pd, direction = "one-sided")) %>%
              ungroup() %>%
              select(Parameter, p),
            by = "Parameter") %>%
  select(Parameter, MAP_Estimate, CI_95_lower, CI_95_upper, pomp_MAP_Estimate, pomp_CI_95_lower, pomp_CI_95_upper, p) %>%
  mutate_at(.vars = c("MAP_Estimate", "CI_95_lower", "CI_95_upper"), round, digits = 2) %>%
  mutate_at(.vars = c("pomp_MAP_Estimate", "pomp_CI_95_lower", "pomp_CI_95_upper"), round, digits = 1)

estimates_imp_deepfaked_detected %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

## Behavioural intentions

```{r}

fit_intentions_deepfaked_detected <- 
  brm(formula = IAT_D2 ~ source_valence, # no random effect for experiment as only exp 6 assessed intentions
      data    = data_detectors_subset, 
      file    = "models/fit_intentions_deepfaked_detected",
      prior   = prior(normal(0, 10)),
      iter    = 6000,
      warmup  = 3000,
      control = list(adapt_delta = 0.95),
      chains  = 4,
      cores   = parallel::detectCores())

# # inspect convergence
# fit_intentions_deepfaked_detected

#plot_model(fit_intentions_deepfaked_detected)
plot_model(fit_intentions_deepfaked_detected, type = "pred", terms = "source_valence")

draws_intentions_deepfaked_detected <- 
  select(spread_draws(fit_intentions_deepfaked_detected, b_source_valencepositive), b_source_valencepositive) %>%
  rename(effect_deepfake_detected = b_source_valencepositive) 

estimates_intentions_deepfaked_detected <- 
  map_estimate(draws_intentions_deepfaked_detected) %>%
  mutate(pomp_MAP_Estimate = ifelse(Parameter == "percent_comparison", NA, (((MAP_Estimate+3)/6) - .50)*100)) %>%
  full_join(bayestestR::hdi(draws_intentions_deepfaked_detected, ci = .95) %>%
              rename(CI_95_lower = CI_low,
                     CI_95_upper = CI_high) %>%
              mutate(pomp_CI_95_lower = ifelse(Parameter == "percent_comparison", NA, (((CI_95_lower+3)/6) - .50)*100),
                     pomp_CI_95_upper = ifelse(Parameter == "percent_comparison", NA, (((CI_95_upper+3)/6) - .50)*100)) %>%
              as_tibble(),
            by = "Parameter") %>%
  full_join(draws_intentions_deepfaked_detected %>%
              gather(Parameter, value) %>%
              group_by(Parameter) %>%
              summarize(pd = mean(value > 0)) %>%
              mutate(p = pd_to_p(pd, direction = "one-sided")) %>%
              ungroup() %>%
              select(Parameter, p),
            by = "Parameter") %>%
  select(Parameter, MAP_Estimate, CI_95_lower, CI_95_upper, pomp_MAP_Estimate, pomp_CI_95_lower, pomp_CI_95_upper, p) %>%
  mutate_at(.vars = c("MAP_Estimate", "CI_95_lower", "CI_95_upper"), round, digits = 2) %>%
  mutate_at(.vars = c("pomp_MAP_Estimate", "pomp_CI_95_lower", "pomp_CI_95_upper"), round, digits = 1)

estimates_intentions_deepfaked_detected %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```


